# Kratos + SA-Token é›†æˆç¤ºä¾‹ - é¡¹ç›®æ€»ç»“

## âœ… å®Œæˆå†…å®¹

### 1. Proto å®šä¹‰ï¼ˆAPI å±‚ï¼‰
- âœ… åˆ›å»º `api/helloworld/v1/user.proto`
- âœ… å®šä¹‰ User æœåŠ¡çš„ 6 ä¸ªæ¥å£ï¼š
  - Login - ç”¨æˆ·ç™»å½•
  - Logout - ç”¨æˆ·ç™»å‡º
  - GetUserInfo - è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç™»å½•ï¼‰
  - AdminOnly - ç®¡ç†å‘˜æ¥å£ï¼ˆéœ€è¦ admin è§’è‰²ï¼‰
  - EditUser - ç¼–è¾‘ç”¨æˆ·ï¼ˆéœ€è¦ user.edit æƒé™ï¼‰
  - PublicInfo - å…¬å¼€ä¿¡æ¯ï¼ˆæ— éœ€ç™»å½•ï¼‰

### 2. æœåŠ¡å±‚å®ç°
- âœ… `internal/service/service.go` - åˆ›å»º SA-Token Manager
- âœ… `internal/service/user.go` - å®ç°æ‰€æœ‰ç”¨æˆ·æœåŠ¡æ¥å£
- âœ… ç¡¬ç¼–ç ä¸‰ä¸ªæµ‹è¯•è´¦å·ï¼ˆadmin, user, editorï¼‰
- âœ… å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Manager API

### 3. ä¸­é—´ä»¶é…ç½®
- âœ… `internal/server/http.go` - é…ç½® SA-Token ä¸­é—´ä»¶
- âœ… æ¼”ç¤ºå¤šç§è·¯ç”±ä¿æŠ¤ç­–ç•¥ï¼š
  - Skip - è·³è¿‡å…¬å¼€è·¯ç”±
  - RequireLogin - éœ€è¦ç™»å½•
  - RequireRole - éœ€è¦è§’è‰²
  - RequirePermission - éœ€è¦æƒé™

### 4. ä¾èµ–ç®¡ç†
- âœ… æ›´æ–° `go.mod` æ·»åŠ  SA-Token ä¾èµ–
- âœ… ä½¿ç”¨ replace æŒ‡å‘æœ¬åœ°æ¨¡å—
- âœ… Wire ä¾èµ–æ³¨å…¥é…ç½®

### 5. æ–‡æ¡£
- âœ… `README_SATOKEN.md` - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£ï¼ˆ70+ è¡Œï¼‰
- âœ… `IMPLEMENTATION.md` - å®ç°è¯´æ˜æ–‡æ¡£
- âœ… `test.sh` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

## ğŸ“Š æ ¸å¿ƒæŠ€æœ¯å±•ç¤º

### SA-Token æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | å®ç°ä½ç½® | ä»£ç ç¤ºä¾‹ |
|------|----------|----------|
| **ç™»å½•** | user.go::Login | `token, err := s.manager.Login(userID)` |
| **ç™»å‡º** | user.go::Logout | `err := s.manager.Logout(token)` |
| **è§’è‰²éªŒè¯** | http.go | `.RequireRole("admin")` |
| **æƒé™éªŒè¯** | http.go | `.RequirePermission("user.edit")` |
| **è®¾ç½®è§’è‰²** | user.go::Login | `s.manager.SetRoles(userID, roles)` |
| **è®¾ç½®æƒé™** | user.go::Login | `s.manager.SetPermissions(userID, perms)` |
| **è·å–ç™»å½•ID** | user.go | `loginID, err := s.manager.GetLoginID(token)` |

### Kratos é›†æˆç‰¹ç‚¹

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **ä¸­é—´ä»¶é›†æˆ** | æ— ç¼é›†æˆåˆ° Kratos ä¸­é—´ä»¶é“¾ |
| **Context é€‚é…** | `sakratos.NewKratosContext(ctx)` é€‚é…å™¨ |
| **é“¾å¼ API** | æµç•…çš„è·¯ç”±è§„åˆ™é…ç½® |
| **çµæ´»åŒ¹é…** | æ”¯æŒé€šé…ç¬¦ã€å‰ç¼€ã€åç¼€ã€æ­£åˆ™ç­‰å¤šç§åŒ¹é…æ–¹å¼ |
| **ä¼˜å…ˆçº§æ§åˆ¶** | æ”¯æŒè®¾ç½®è§„åˆ™ä¼˜å…ˆçº§ |

## ğŸ¯ è®¾è®¡äº®ç‚¹

### 1. ç®€åŒ–è®¾è®¡
- ä¸ä¾èµ– biz/data å±‚ï¼Œç›´æ¥åœ¨ service å±‚ç¡¬ç¼–ç æ¼”ç¤º
- é‡ç‚¹çªå‡º SA-Token çš„ä½¿ç”¨æ–¹å¼
- ä»£ç ç®€æ´æ¸…æ™°ï¼Œæ˜“äºç†è§£

### 2. å®Œæ•´ç¤ºä¾‹
- è¦†ç›–ç™»å½•ã€ç™»å‡ºã€è§’è‰²ã€æƒé™ç­‰æ ¸å¿ƒåœºæ™¯
- æä¾›ä¸‰ç§ä¸åŒæƒé™çš„æµ‹è¯•è´¦å·
- åŒ…å«è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

### 3. æœ€ä½³å®è·µ
- ä½¿ç”¨ Wire è¿›è¡Œä¾èµ–æ³¨å…¥
- Manager å•ä¾‹æ¨¡å¼
- ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†è®¤è¯é€»è¾‘

## ğŸ“ æ–‡ä»¶ç»“æ„

```
examples/kratos/kratos-example/
â”œâ”€â”€ api/helloworld/v1/
â”‚   â”œâ”€â”€ user.proto          # æ–°å¢ï¼šç”¨æˆ·æœåŠ¡ Proto å®šä¹‰
â”‚   â””â”€â”€ user.pb.go          # ç”Ÿæˆçš„ä»£ç 
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ http.go         # ä¿®æ”¹ï¼šæ·»åŠ  SA-Token ä¸­é—´ä»¶
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ service.go      # ä¿®æ”¹ï¼šæ·»åŠ  Manager Provider
â”‚       â””â”€â”€ user.go         # æ–°å¢ï¼šç”¨æˆ·æœåŠ¡å®ç°
â”œâ”€â”€ IMPLEMENTATION.md       # æ–°å¢ï¼šå®ç°è¯´æ˜
â”œâ”€â”€ README_SATOKEN.md       # æ–°å¢ï¼šè¯¦ç»†æ–‡æ¡£
â””â”€â”€ test.sh                 # æ–°å¢ï¼šæµ‹è¯•è„šæœ¬
```

## ğŸš€ å¦‚ä½•è¿è¡Œ

1. **æ„å»º**
```bash
go mod tidy
go build -o bin/server cmd/kratos-example/*.go
```

2. **è¿è¡Œ**
```bash
./bin/server
```

3. **æµ‹è¯•**
```bash
# è‡ªåŠ¨åŒ–æµ‹è¯•
./test.sh

# æ‰‹åŠ¨æµ‹è¯•
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### å¯¹äº SA-Token ç”¨æˆ·
1. å¦‚ä½•åœ¨ Kratos ä¸­åˆå§‹åŒ– Manager
2. å¦‚ä½•é…ç½®ä¸­é—´ä»¶å’Œè·¯ç”±è§„åˆ™
3. å¦‚ä½•åœ¨æœåŠ¡ä¸­ä½¿ç”¨ Manager API

### å¯¹äº Kratos ç”¨æˆ·
1. å¦‚ä½•é›†æˆç¬¬ä¸‰æ–¹è®¤è¯åº“
2. ä¸­é—´ä»¶çš„é…ç½®æ–¹å¼
3. Wire ä¾èµ–æ³¨å…¥çš„ä½¿ç”¨

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å­˜å‚¨é€‰æ‹©**ï¼šç¤ºä¾‹ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis
2. **ç¡¬ç¼–ç æ•°æ®**ï¼šç”¨æˆ·æ•°æ®ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œä»…ç”¨äºæ¼”ç¤º
3. **é”™è¯¯å¤„ç†**ï¼šç®€åŒ–äº†é”™è¯¯å¤„ç†ï¼Œå®é™…é¡¹ç›®åº”æ›´å®Œå–„
4. **Token ä¼ é€’**ï¼šæ”¯æŒ Headerã€Cookie å¤šç§æ–¹å¼

## ğŸ”— ç›¸å…³é“¾æ¥

- [SA-Token å®˜æ–¹æ–‡æ¡£](https://sa-token.cc/)
- [SA-Token Go ç‰ˆæœ¬](https://github.com/click33/sa-token-go)
- [Kratos å®˜æ–¹æ–‡æ¡£](https://go-kratos.dev/)

---

**æ€»ç»“**ï¼šæœ¬ç¤ºä¾‹ç®€æ´æ˜äº†åœ°å±•ç¤ºäº†å¦‚ä½•åœ¨ Kratos æ¡†æ¶ä¸­é›†æˆå’Œä½¿ç”¨ SA-Tokenï¼Œæ¶µç›–äº†è®¤è¯ã€è§’è‰²ã€æƒé™ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ˜¯å­¦ä¹ å’Œå‚è€ƒçš„æœ€ä½³å®è·µã€‚
